<!DOCTYPE html> <!-- Greg Daynes by Gregory Daynes URL: https://gregdaynes.com --> <html lang="en-GB"> <head> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Cupped Brews — Code Demonstrations &amp; Experiments | Greg Daynes</title> <meta name="generator" content="Jekyll v4.3.3" /> <meta property="og:title" content="Cupped Brews — Code Demonstrations &amp; Experiments" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Collected projects and playgrounds. Most often to figure out a problem for work, also for fun." /> <meta property="og:description" content="Collected projects and playgrounds. Most often to figure out a problem for work, also for fun." /> <link rel="canonical" href="https://gregdaynes.com/post/2021/09/19/cupped-brews.html" /> <meta property="og:url" content="https://gregdaynes.com/post/2021/09/19/cupped-brews.html" /> <meta property="og:site_name" content="Greg Daynes" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-09-19T00:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Cupped Brews — Code Demonstrations &amp; Experiments" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-19T00:00:00+00:00","datePublished":"2021-09-19T00:00:00+00:00","description":"Collected projects and playgrounds. Most often to figure out a problem for work, also for fun.","headline":"Cupped Brews — Code Demonstrations &amp; Experiments","mainEntityOfPage":{"@type":"WebPage","@id":"https://gregdaynes.com/post/2021/09/19/cupped-brews.html"},"url":"https://gregdaynes.com/post/2021/09/19/cupped-brews.html"}</script> <!-- End Jekyll SEO tag --> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="page-datetime" content=""> <meta name="author" content="/humans.txt"> <meta name="keywords" content=""> <meta name="no-email-collection" content="/privacy.txt"> <meta name="description" content="The website and home of Gregory Daynes. Find links to projects, notebooks, and resume."> <meta name='HandheldFriendly' content='True'> <meta name='MobileOptimized' content='375'> <title>Cupped Brews — Code Demonstrations & Experiments &bull; Greg Daynes</title> <link href='/assets/fonts/fonts.css' rel='stylesheet'> <link rel="stylesheet" href="/assets/css/variables-reset-utils-base-header-footer-toc-list-e9d68a.css?"> <link rel="stylesheet" href="/assets/css/card-26e86d.css?"> <link rel="stylesheet" href="/assets/css/post-4d935c.css?"> <link rel="author" href="/humans.txt" /> <link type="application/atom+xml" rel="alternate" href="https://gregdaynes.com/feed.xml" title="Greg Daynes" /> <link rel="shortcut icon" href="/assets/img/favicon-32x32.png" /> <body class="page cupped-brews-—-code-demonstrations-&-experiments"> <header> <hgroup> <h1><a href="/">Greg Daynes</a></h1> <h2>Full Stack Software Design, Development & Management</h2> </hgroup> <nav class="center"> <a href="/">Home</a> <a href="/about">About</a> <a href="/resume">Resume</a> <a href="/projects">Projects</a> <a href="/notebook">Notebook</a> </nav> </header> <div class="main-wrapper"> <main> <article> <h2>Cupped Brews — Code Demonstrations & Experiments <hr></h2> <ul id="markdown-toc"> <li><a href="#lazy-short-urls" id="markdown-toc-lazy-short-urls">Lazy Short URLS</a></li> <li><a href="#composability-with-entity-component-systems" id="markdown-toc-composability-with-entity-component-systems">Composability with Entity-Component Systems</a></li> <li><a href="#redis-recovery" id="markdown-toc-redis-recovery">Redis Recovery</a></li> <li><a href="#sweepline" id="markdown-toc-sweepline">Sweepline</a></li> <li><a href="#context-aware-logging" id="markdown-toc-context-aware-logging">Context-Aware Logging</a></li> <li><a href="#envar-loading" id="markdown-toc-envar-loading">Envar Loading</a></li> <li><a href="#cli--binary-artifact" id="markdown-toc-cli--binary-artifact">CLI / Binary Artifact</a></li> <li><a href="#app-example" id="markdown-toc-app-example">App Example</a></li> </ul> <p>I realize how disorganized my Github repository list has become. Until I tidy it, this list will serve as <em>things I have worked on recently</em>.</p> <h2 id="lazy-short-urls">Lazy Short URLS</h2> <p>Repo: <a href="https://github.com/gregdaynes/shortr">gregdaynes/shortr</a></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run application web server on port 3000</span>
<span class="nv">$ </span>npm start
</code></pre></div></div> <p>Recently when a friend was interviewing for a job, one of the code challenges was to create a url shortener. I decided to give it a try.</p> <ul> <li>Encode the recieved url with HMAC from Node’s internal crypto library - <a href="https://github.com/gregdaynes/shortr/blob/492cb8fe770fef12ac8ca8f1c291413f3f0c82df/index.mjs#L36-L41">Link</a></li> <li>Append an entry <code class="language-plaintext highlighter-rouge">${hash}:${url}</code> to a plaintext file - <a href="https://github.com/gregdaynes/shortr/blob/492cb8fe770fef12ac8ca8f1c291413f3f0c82df/index.mjs#L47-L48">link</a></li> <li>Stores hash:url in a Set (Restored from the plaintext file on start) - <a href="https://github.com/gregdaynes/shortr/blob/492cb8fe770fef12ac8ca8f1c291413f3f0c82df/index.mjs#L7-L20">link</a></li> </ul> <h2 id="composability-with-entity-component-systems">Composability with Entity-Component Systems</h2> <p>Repo: <a href="https://github.com/gregdaynes/entity-component">gregdaynes/entity-component</a></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run application, stdout JSON data results</span>
<span class="nv">$ </span>npm start

<span class="c"># Run application with profiling data, stdout pretty JSON data &amp; performance metrics/telemetry</span>
<span class="nv">$ </span>npm run profile
</code></pre></div></div> <p>An exploration of Entity-Component System pattern used in game development. I wanted to see if the pattern could help with legibility and composability.</p> <p>While not as performant as the original implementation. EC proved to be a happy in-between performance and maintainability. I found it to be like <a href="/function-composition">Function Composition</a> as well as way more memory efficient (this is where EC proves it’s value).</p> <p>The concept is for entites to act as containers of data with a global unique dentifier. The logic exists outside of the entities in systems. Each system operates on entities which have the components the system knows about. Usually a system performs arithmetic, which makes it fast and efficient.</p> <p>This served as a place to experiment with the new <a href="https://nodejs.org/dist/latest-v16.x/docs/api/perf_hooks.html#perf_hooks_performance_measurement_apis">Performance Hooks</a> API.</p> <ul> <li>Choosing to write this using Classes instead of Prototype, I found it to be more legible. Programmers coming from OOP languages like Ruby makes this easier to understand.</li> <li>For/of loops and if/else blocks are also used instead of collection methods like map/reduce. Ease for programmers of all levels to understand without Javascript collections knowledge. And keep me away from long method chains.</li> <li>Main loop which performs 100,000 frames (iterations) of systems over the entities - <a href="https://github.com/gregdaynes/entity-component/blob/5a859c67f7e9ce161e10daefd38dd6d43378f8de/src/index.js#L60-L75">link</a></li> <li>Entity factory shows creation of entities with their components- <a href="https://github.com/gregdaynes/entity-component/blob/5a859c67f7e9ce161e10daefd38dd6d43378f8de/src/factory-ship.js">link</a></li> <li>Customizing entities with more components - <a href="https://github.com/gregdaynes/entity-component/blob/5a859c67f7e9ce161e10daefd38dd6d43378f8de/src/index.js#L43-L50">link</a></li> <li>Entity Manager which maintains collections of entities and their components - <a href="https://github.com/gregdaynes/entity-component/blob/5a859c67f7e9ce161e10daefd38dd6d43378f8de/src/lib/entity-manager.js">link</a></li> <li>Wrapper for perf hooks - <a href="https://github.com/gregdaynes/entity-component/blob/5a859c67f7e9ce161e10daefd38dd6d43378f8de/src/lib/perf.js">link</a></li> </ul> <p>I’m still exploring the posibile applications of an EC-like pattern outside of games.</p> <h2 id="redis-recovery">Redis Recovery</h2> <p>Repo: <a href="https://github.com/gregdaynes/redis-recovery">gregdaynes/redis-recovery</a></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># I don't recommend running this application - Bull queue data + env is required</span>
</code></pre></div></div> <p>This script came out of a need one Saturday where an applications job queue was not working as expected. <em>I am fuzzy on details of what had ocurred</em>. It might been from moving job data over to an Elixir application. I attempted fixing with several Redis admin tools, but the dataset ended up being too large.</p> <ul> <li>Uses event emitter, which was nice for developing in a pipeline style, while ignoring order.</li> <li>This was my first Node ESM module.</li> <li>In hindsight the use of Redis instead of IO Redis made things more annoying Promisify - <a href="https://github.com/gregdaynes/redis-recovery/blob/965d236cb8671c42d32c4b54ff03e05aa6e2b116/index.js#L7-L11">link</a></li> <li>I am not sure why I used promisify with <code class="language-plaintext highlighter-rouge">node:fs/appendFile</code> when a better option would be to use <code class="language-plaintext highlighter-rouge">node:fs/promises</code> - <a href="https://github.com/gregdaynes/redis-recovery/blob/965d236cb8671c42d32c4b54ff03e05aa6e2b116/index.js#L11">link</a></li> </ul> <h2 id="sweepline">Sweepline</h2> <p>Repo: <a href="https://github.com/gregdaynes/sweepline">gregdaynes/sweepline</a></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Run application, stdout JSON data results</span>
<span class="nv">$ </span>npm start
</code></pre></div></div> <p>This is a modified and incomplete implementation of the <a href="https://en.wikipedia.org/wiki/Sweep_line_algorithm">Sweep Line algorithm</a>. I developed this to take a small set of around 100k objects, containing key date data. The goal was to group the objects based on their dates, without overlapping. Objects could span many group. Additionally the function needed to be isomorphic, and fast enough that it would not block rendering (60fps) in the browser.</p> <p>A visualization of the data, and desired output</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input
                  ┌─────┐
                  │  C  │
                  └─────┘
    ┌───┐ ┌────┐      ┌─────────┐
    │ B │ │ B  │      │    B    │
    └───┘ └────┘      └─────────┘
 ┌──────────┐  ┌───┐         ┌───┐
 │    A     │  │ A │         │ A │
 └──────────┘  └───┘         └───┘
──────────────────────────────────▶
               Time

Results
 ┌──┬───┬─┬─┬──┬──┬┬──┬─┬────┬──┬┐
─┴──┴───┴─┴─┴──┴──┴┴──┴─┴────┴──┴┴▶
  A   A  A A B  A  A C B   B  A A
      B    B       C   C      B
</code></pre></div></div> <p>Sweepline proved to be useful in a few areas of the application. Cleaning up logic unique to each implementation which was</p> <ul> <li>illegible—nested foreach loops</li> <li>terse—nested ternary</li> <li>untested—untestable code</li> </ul> <h2 id="context-aware-logging">Context-Aware Logging</h2> <p>Repo: <a href="https://github.com/gregdaynes/chip-log">gregdaynes/chip-log</a></p> <p>Readme in repository has a breakdown of installation and usage.</p> <p>One of the last projects I used Express on, had logging issues.</p> <ul> <li>Context between backend services,</li> <li>performance constraints,</li> <li>PII in the output.</li> </ul> <p>Chip Log is a wrapper around PinoJS (a recommended replacement for other loggers like Morgan and Winston).</p> <p>I no longer work to maintain this module. Instead directing attention to Fastify which has existing extensions providing these features. It should still work. The inspector will <em>probably</em> break on Node 15+ and definitely can’t operate in ESM mode.</p> <h2 id="envar-loading">Envar Loading</h2> <p>Repo: <a href="https://github.com/gregdaynes/env">gregdaynes/env</a></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Start node repl with envars
$ node -r ./env-loader.js

# node repl
&gt; console.log(process.env)
</code></pre></div></div> <p>Envars are one of those things that seems to bite new members to a project. Most of the time they’re not documented, typed, and local setups gain invalid values over time. I wanted a way to simplify the process, as well as provide useful information to the developer.</p> <ul> <li>Use JSON Schema to parse, validate, and provide defaults for values - <a href="https://github.com/gregdaynes/env/blob/e6642323fc450e18cb1b80dfccad17f7fc99751d/env-schema.js">link</a></li> <li>Uses common .env file with newline separated KEY=VALUE entries.</li> <li><code class="language-plaintext highlighter-rouge">TEST_</code> prefixed values will override un-prefixed values in NODE_ENV=test to avoid having multiple .env.* files.</li> </ul> <h2 id="cli--binary-artifact">CLI / Binary Artifact</h2> <p>Repo: <a href="https://github.com/gregdaynes/pkg-test">gregdaynes/pkg-test</a></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Build binaries
$ npm run build

# Run Binary
# ./pkg-test
</code></pre></div></div> <p>A friend asked if it was possible to create binaries of a node application like Deno. I figured it would be a solved-problem, but didn’t realize how easy it would be. Using Vercel’s PKG package, it <em>just</em> works.</p> <p><em>Note:</em> This repo currently does not compile or execute on M1 Macs. I haven’t bothered to investigate, but should be reasonable to resolve.</p> <h2 id="app-example">App Example</h2> <p>Repo: <a href="https://github.com/gregdaynes/app-example">app-example</a></p> <p>Readme in repository has in-depth documentation on the organization, cli, code generation, testing, database.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install modules for each area of the application</span>
<span class="nv">$ </span>npm run setup

<span class="c"># Add required keyvalues to .env</span>
<span class="c"># starting the application will inform you what required values are missing</span>
<span class="c"># you can use the following</span>
<span class="nv">JWT_SECRET</span><span class="o">=</span>supersecret
<span class="nv">DB_CLIENT</span><span class="o">=</span>mysql
<span class="nv">DB_USER</span><span class="o">=</span>root
<span class="nv">DB_PASSWORD</span><span class="o">=</span>root
<span class="nv">DB_DATABASE</span><span class="o">=</span>app
<span class="nv">DB_HOST</span><span class="o">=</span>127.0.0.1
<span class="nv">DB_PORT</span><span class="o">=</span>3306
<span class="nv">TEST_DB_CLIENT</span><span class="o">=</span>sqlite3
<span class="nv">TEST_DB_FILENAME</span><span class="o">=</span>:memory:
<span class="nv">TEST_DB_POOL_MIN</span><span class="o">=</span>1
<span class="nv">TEST_DB_POOL_MAX</span><span class="o">=</span>1

<span class="c"># Setup Database</span>
<span class="c"># if you don't have a local MySQL install, you can use the docker compose file included in this project to set up quickly.</span>
<span class="c"># Note that the envars for MYSQL_ROOT_PASSWORD and MYSQL_DATABASE need to be defined in .env before running the following command.</span>
<span class="nv">$ </span>docker compose up <span class="nt">-d</span>

<span class="c"># Migrate + Seed database</span>
<span class="c"># you can use the script `db` to perform operations with KnexJS or use the CLI</span>
<span class="nv">$ </span>npm run cli

<span class="nv">$ </span>npm run db <span class="nt">--</span> migrate:latest
<span class="nv">$ </span>npm run db <span class="nt">--</span> seed:run

<span class="c"># Running API Server</span>
<span class="nv">$ </span>npm run start:api
<span class="c"># pino-pretty can provide cleaner stdout logs for dev</span>
<span class="nv">$ </span>npm run start:api | npx pino-pretty

<span class="c"># Running Tests</span>
<span class="c"># app tests</span>
<span class="nv">$ </span>npm run <span class="nb">test</span>:app
<span class="c"># api tests</span>
<span class="nv">$ </span>npm run <span class="nb">test</span>:api
<span class="c"># api &amp; app tests</span>
<span class="nv">$ </span>npm run <span class="nb">test</span>
</code></pre></div></div> <p>A <em>mostly</em> complete example for a monolith, which is also suitable for building “microservices”.</p> <ul> <li>Mocha used as test runner for both the Api and the frontend (frontend excluded from this repository). I would personally choose to use <a href="https://www.npmjs.com/package/tap">tap</a> for the Api, and Jest for the Frontend. I dislike Jest for testing Node because of the changes made to the runtime. There are also issues with slow adoption of newer capabilities (because of the these changes)—eg: ESM</li> <li>Replacing the database with SQLite when testing has been a positive choice for fast development (TDD). Given the choice again I would opt to use an in-memory-tuned instance of the production database for integration testing.</li> <li>No workspaces. I ran into an issue with other developers NPM not working with the <em>then new</em> workspace feature (NPM @ 7). Yarn would have worked for this, as well as PNPM.</li> <li>Hygen for generating code based on <code class="language-plaintext highlighter-rouge">ejs</code> templates - <a href="https://www.npmjs.com/package/copy-template-dir">copy-template-dir</a> or similar.</li> <li>CLI came after most of the application and web interface was complete. Nowadays I would build the CLI in parallel with the application logic. This benefits development by not having to remember REPL commands or building out administration uis.</li> </ul> <p>The repository contains <code class="language-plaintext highlighter-rouge">app-example-requests.paw</code> and <code class="language-plaintext highlighter-rouge">app-example-requests-postman.json</code> for interacting with the api through Paw or Postman.</p> </article> </main> <aside> <section> <h2>Projects <hr></h2> <div class="card-deck"> <a class="card" href="/project/2023/11/11/turing-pi.html">Turing Pi</a> <a class="card" href="/project/2023/12/04/hyde-page-css-js.html">Hyde Page CSS & JS</a> <a class="card" href="/project/2023/12/28/fellow-stagg-repair.html">Fellow Stagg Repair</a> <a class="card" href="/project/2018/04/07/project-hyde.html">Project Hyde</a> </div> <span><a class="more" href="/projects">More Projects</a></span> </section> <section> <h2>Notes <hr></h2> <ol class="toc-list"> <li> <span class="row"> <span class="title"> <a href="/note/2023/12/08/fixing-homebrew-permissions.html">Fixing Hombrew permissions when using ASDF</a> </span> </span> </li> </ol> <span><a class="more" href="/notebook">More Notes</a></span> </section> </aside> </div> <footer> <div>©MMXXIV Gregory Daynes</div> <nav> <a href="mailto:email@gregdaynes.com">Contact</a> <a href="/privacy.txt">Privacy</a> <a href="/humans.txt">Humans</a> <a href="/robots.txt">Robots</a> <a href="/sitemap.xml">Site Map</a> <a href="/feed.xml">RSS</a> </nav> <p><small>Content on this site is licensed under Creative Common Attribution-ShareAlike 4.0 International License. All code content is licensed under the MIT license, unless an excerpt from a larger work under another license.</small></p> </footer> <script src="/assets/js/fittext-header-365689.js"></script> </body> </html>
