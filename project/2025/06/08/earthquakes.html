<!DOCTYPE html><html lang=en-GB><head><meta name=viewport content="width=device-width, initial-scale=1"><meta name=keywords content=""><meta name=no-email-collection content="/privacy.txt"><meta name=twitter:card content=summary_large_image><meta property=og:title content="Earthquakes with Leaflet.js & Go • Greg Daynes"><meta property="og:description" name=description content="The website and home of Gregory Daynes. Find links to projects, notebooks, and resume."><meta property="og:image" content="data:;base64,iVBORw0KGgo="><title>Earthquakes with Leaflet.js & Go • Greg Daynes</title><link rel=me href="//mastodon.social/@gregdaynes"><link rel=author href="/humans.txt"><link rel=icon href="data:;base64,iVBORw0KGgo="><link type="application/atom+xml" rel=alternate href="/feed.xml"><link rel=stylesheet href="/assets/css/variables-critical-text-fit-toc-list-88113d.css"><style>code{font-size:.9em}p>code{background:var(--_color-background-code)}div.highlight{overflow:scroll;background:var(--_color-background-code)}pre{margin-block:0;padding:var(--s-1);border-radius:3px;overflow-x:auto}.footnotes p{margin-block-end:0}blockquote{border-inline-start:4px solid;padding-inline-start:1rem;margin-inline:auto;font-weight:bold;font-style:italic}</style></head><body class="page earthquakes-with-leaflet.js-&-go"><img src="//analytics.app.gregdaynes.com?type=image&page=/project/2025/06/08/earthquakes.html" width=0 height=0 /><header><h1 class=text-fit><span><a data-text="Greg Daynes" href="/">Greg Daynes</a></span><span aria-hidden=true style="visibility: hidden">Greg Daynes</span></h1><p class=text-fit><span><span>Full Stack Software Design, Development & Management</span></span><span aria-hidden=true style="visibility: hidden">Full Stack Software Design, Development & Management</span></p><nav><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/resume">Resume</a></li><li><a href="/projects">Projects</a></li><li><a href="/notebook">Notebook</a></li></ul></nav></header><div class=with-sidebar><main><article><h2>Earthquakes with Leaflet.js & Go</h2><p>Living on the Juan de Fuca plate means earthquakes happen every day. Sometimes multiple times. While we wait for <em>the big one</em>, why not visualize some of the quakes.</p><style>
quake-map {
    position: relative;
    display: block;
    width: 100%;
    height: auto;
    aspect-ratio: 1/1;
}
</style><quake-map data-api="https://quake.app.gregdaynes.com/api/v1/" data-marker-icon="/assets/images/marker-icon.png" data-marker-shadow="/assets/images/marker-shadow.png"></quake-map><script type=module src="/assets/js/quake.js"></script><p>The stack consists of</p><ul><li>RSS/Atom feed from <a href="//www.earthquakescanada.nrcan.gc.ca/index-en.php">Earthquakes Canada</a></li><li><a href="//github.com/gregdaynes/earthquake-service/tree/main/backend">Go service</a></li><li><a href="//github.com/gregdaynes/earthquake-service/tree/main/frontend">Plain web component</a></li></ul><h2 id=the-go-service>The Go service</h2><p>Designed to be simple to operate. It uses the stdlib <code class="language-plaintext highlighter-rouge">http/ServeMux</code><sup id="fnref:1"><a href="#fn:1" class=footnote rel=footnote role=doc-noteref>1</a></sup> library for it’s request/responses, exposes 2 endpoints <code class="language-plaintext highlighter-rouge">/api/v1/</code> and <code class="language-plaintext highlighter-rouge">/api/v1/update</code>.<code class="language-plaintext highlighter-rouge">modernc/sqlite</code><sup id="fnref:2"><a href="#fn:2" class=footnote rel=footnote role=doc-noteref>2</a></sup> for the SQLite driver, and <code class="language-plaintext highlighter-rouge">GoFeed</code><sup id="fnref:3"><a href="#fn:3" class=footnote rel=footnote role=doc-noteref>3</a></sup> for handling the ATOM feed.</p><h3 id=updating--refreshing-the-data>Updating &amp; Refreshing the Data</h3><p>The <code class="language-plaintext highlighter-rouge">/api/v1/update</code> endpoint, when called, triggers the fetch, parse, and store of the RSS feed. While the endpoint can be triggered by any request, the intended method is through cURL<sup id="fnref:4"><a href="#fn:4" class=footnote rel=footnote role=doc-noteref>4</a></sup> from a local crontab<sup id="fnref:5"><a href="#fn:5" class=footnote rel=footnote role=doc-noteref>5</a></sup>.</p><p><em>The endpoint maintains in-memory state of the last fetch timestamp, ensuring we don’t fetch the data through public access.</em></p><h3 id=persistence>Persistence</h3><p>The data received from the RSS/ATOM feed, is stored in a local SQLite database. For applications like this, you can’t beat it (maybe writing to disk yourself). It’s fast, small, and works well with most languages. Node.js<sup id="fnref:6"><a href="#fn:6" class=footnote rel=footnote role=doc-noteref>6</a></sup> recently started bundling it in, and I miss that with Golang, however its setup is simple, with the stdlib DB library, and the available drivers.</p><p>This is also the first time using my <a href="//github.com/gregdaynes/earthquake-service/blob/3c39487dc1c63c6807891f3a4d8c2426b777eb31/backend/cmd/web/db.go">schema based migration module</a> in production - which I started working on a while ago for various other project.The idea is that provided a schema in SQL, it will automatically apply the schema changes, and recreate indexes, like in Rails, and Directus.</p><h3 id=hosting>Hosting</h3><p>This is the first time I’m hosting a Go service for myself, so I took this opportunity to think about a low-maintenance approach.</p><p>Instead of putting the app in Docker, I run the service with SystemD<sup id="fnref:7"><a href="#fn:7" class=footnote rel=footnote role=doc-noteref>7</a></sup>. This handles the starting, stopping, and restarting the service on failure.</p><pre><code class="language-unit">[Unit]
Description=Quake App

[Service]
Environment="QUAKE_ARGS=-port=9001"
ExecStart=/var/apps/quakes.linux_amd64 $QUAKE_ARGS
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
</code></pre><p>Refreshing the data is done every 30 minutes through <code class="language-plaintext highlighter-rouge">cron</code></p><pre><code class="language-crontab">*/30 * * * * curl https://quake.app.gregdaynes.com/api/v1/update
</code></pre><p>I opted for Caddy<sup id="fnref:8"><a href="#fn:8" class=footnote rel=footnote role=doc-noteref>8</a></sup> instead of Nginx<sup id="fnref:9"><a href="#fn:9" class=footnote rel=footnote role=doc-noteref>9</a></sup> for a reverse proxy. I have been playing with it for a few years, and I think it’s time to make the switch. Automatic SSL is nice, and the very simple configuration in Caddyfile is quite friendly.</p><p>The SQLite database is backed up and restored through Litestream<sup id="fnref:10"><a href="#fn:10" class=footnote rel=footnote role=doc-noteref>10</a></sup>. Which if you’re working on services backed with SQLite, it’s a must.</p><p>After warmup of 100k requests hitting around 3500req/s from my laptop, Caddy is running at 64M, and the Quake service at 20M. That’s pretty nifty when compared to Node.js which usually starts around 80M and Nginx 22M for basic 80/443 configurations.</p><p>I should note at the time of writing, this is hosted in Toronto, Canada through Digital Ocean on AMD64 1GB/1VCPU @2.0GHz. There’s lots of room on this server if everything is going to be so light on resources.</p><h3 id=fetching-data>Fetching Data</h3><p>Nothing interesting about this, it’s an endpoint that receives diagonal coordinates, and returns JSON describing all the points inside the provided bounds. This is not designed to be robust, it does not feature paginated data, query limiting, or anything fancy. The data is Canada specific, so while you can request any coordinates, it will always be limited to Canada.</p><h2 id=web-component>Web Component</h2><p>I love plain, vanilla HTML web components. I think they’re the way to build components, multi-page applications, and even single page applications going forward. They’re robust, supported across all browsers, and aren’t yet another framework to learn.</p><p>The component itself is not pretty. I wasn’t going for greatness, just viable. It’s <a href="//leafletjs.com/2025/05/18/leaflet-2.0.0-alpha.html">leaflet 2.0-alpha</a>, jammed into a single component, using Shadow DOM, and inlined CSS. Did any of this need to be done? No. But, I have a shiny new tag to place on my site.</p><div class="language-html highlighter-rouge"><div class=highlight><pre class=highlight><code><span class="nt">&lt;quake-map</span> <span class="na">data-api=</span><span class="s">"/api/v1/"</span><span class="nt">&gt;&lt;/quake-map&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span> <span class="na">src=</span><span class="s">"/assets/js/quake.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div><p>This is all that’s needed to render the map and markers on the page.</p><p>It’s built using Vite<sup id="fnref:11"><a href="#fn:11" class=footnote rel=footnote role=doc-noteref>11</a></sup>, but is an unnecessary step (because it’s in a single file to start) but it makes for a nicer time developing.</p><p>As always, let me know what you think through <a href="email@gregdaynes.com">email@gregdaynes.com</a></p><hr/><div class=footnotes role=doc-endnotes><ol><li id="fn:1"><p><a href="//pkg.go.dev/net/http#ServeMux">Golang http/ServeMux</a> <a href="#fnref:1" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:2"><p><a href="//pkg.go.dev/modernc.org/sqlite">modernc/sqlite</a> <a href="#fnref:2" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:3"><p><a href="//pkg.go.dev/github.com/mmcdole/gofeed">GoFeed</a> <a href="#fnref:3" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:4"><p><a href="//curl.se/docs/manpage.html">cURL</a> <a href="#fnref:4" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:5"><p><a href="//www.man7.org/linux/man-pages/man5/crontab.5.html">crontab</a> <a href="#fnref:5" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:6"><p><a href="//nodejs.org/docs/latest/api/sqlite.html">Node.js SQLite</a> <a href="#fnref:6" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:7"><p><a href="//systemd.io">SystemD</a> <a href="#fnref:7" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:8"><p><a href="//caddyserver.com">Caddy</a> <a href="#fnref:8" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:9"><p><a href="//nginx.org">Nginx</a> <a href="#fnref:9" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:10"><p><a href="//litestream.io">Litestream</a> <a href="#fnref:10" class=reversefootnote role=doc-backlink>&#8617;</a></p></li><li id="fn:11"><p><a href="//vite.dev">Vite</a> <a href="#fnref:11" class=reversefootnote role=doc-backlink>&#8617;</a></p></li></ol></div></article></main><aside><h2>Projects</h2><nav><ul><li class=""><a href="/project/2023/12/04/hyde-page-css-js.html"> Hyde Page CSS & JS</a></li><li class=""><a href="/project/2023/12/28/fellow-stagg-repair.html"> Fellow Stagg Repair</a></li><li class=""><a href="/project/2018/04/07/project-hyde.html"> Project Hyde</a></li><li class=""><a href="/project/2023/11/11/turing-pi.html"> Turing Pi</a></li></ul></nav><a href="/projects">More Projects</a><h2>Notes</h2><nav><ul><li class=""><a href="/note/2024/07/30/callable-class-instance.html"> Callable Class Instance</a></li><li class=""><a href="/note/2024/07/29/web-components.html"> Web Components</a></li><li class=""><a href="/note/2024/02/10/hexdump-shell-command.html"> Hexdump shell command</a></li><li class=""><a href="/note/2023/12/08/fixing-homebrew-permissions.html"> Fixing Homebrew permissions when using ASDF</a></li><li class=""><a href="/note/2021/09/18/node-binary-artifacts.html"> Node CLI / Binary Artifacts</a></li></ul></nav><a href="/notebook">More Notes</a></aside></div><footer><p>©2024 Gregory Daynes</p><nav><ul><li><a href="mailto:email@gregdaynes.com">Contact</a></li><li><a href="/privacy.txt">Privacy</a></li><li><a href="/humans.txt">Humans</a></li><li><a href="/robots.txt">Robots</a></li><li><a href="/sitemap.xml">Site Map</a></li><li><a href="/feed.xml">RSS</a></li><li><a href="/stats">Analytics</a></li></ul></nav><p><small>Content on this site is licensed under Creative Common Attribution-ShareAlike 4.0 International License. All code content is licensed under the MIT license, unless an excerpt from a larger work under another license.</small></p></footer></body></html>